<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema MLP - Control Inteligente</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            background: linear-gradient(135deg, #0d1117 0%, #1a1f2e 100%);
            color: #c9d1d9; 
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(22, 27, 34, 0.9);
            border-radius: 12px;
            border: 2px solid #8250df;
            box-shadow: 0 0 30px rgba(130, 80, 223, 0.3);
        }

        h1 { 
            color: #8250df; 
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(130, 80, 223, 0.5);
        }

        .status-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .status-badge {
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .badge-online { 
            background: #238636; 
            color: white;
            box-shadow: 0 0 15px rgba(35, 134, 54, 0.5);
        }

        .badge-offline { 
            background: #da3633; 
            color: white;
            animation: pulse 2s infinite;
        }

        .badge-mlp {
            background: #8250df;
            color: white;
            box-shadow: 0 0 15px rgba(130, 80, 223, 0.5);
        }

        .badge-auto {
            background: #238636;
            color: white;
            box-shadow: 0 0 15px rgba(35, 134, 54, 0.5);
        }

        .badge-manual {
            background: #d29922;
            color: white;
            box-shadow: 0 0 15px rgba(210, 153, 34, 0.7);
        }

        .badge-auth {
            background: #8250df;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .badge-auth:hover {
            transform: scale(1.05);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .section-title {
            color: #8b949e;
            text-transform: uppercase;
            font-size: 1.2em;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #8250df;
            letter-spacing: 2px;
        }

        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px;
        }

        .card { 
            background: linear-gradient(145deg, #161b22 0%, #0d1117 100%);
            border: 1px solid #30363d; 
            border-radius: 12px; 
            padding: 25px; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.6);
        }

        .lbl { 
            color: #8b949e; 
            font-size: 0.85em; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .val { 
            font-size: 3.5em; 
            font-weight: bold; 
            margin: 15px 0;
            background: linear-gradient(135deg, #8250df, #6e40c9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .unit {
            font-size: 0.5em;
            color: #8b949e;
        }

        /* ESTILOS PARA CONFIGURACI√ìN DE HORARIOS */
        .horarios-panel {
            background: linear-gradient(145deg, #161b22 0%, #0d1117 100%);
            border: 2px solid #58a6ff;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 0 30px rgba(88, 166, 255, 0.3);
        }

        .relay-config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .relay-config-card {
            background: rgba(22, 27, 34, 0.6);
            border: 2px solid #30363d;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .relay-config-card.habilitado {
            border-color: #238636;
            box-shadow: 0 0 15px rgba(35, 134, 54, 0.3);
        }

        .relay-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #30363d;
        }

        .relay-config-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #58a6ff;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #30363d;
            transition: .4s;
            border-radius: 30px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #238636;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        .form-group-inline {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-field label {
            color: #8b949e;
            font-size: 0.85em;
            font-weight: 600;
        }

        .form-field input {
            padding: 10px;
            background: #0d1117;
            border: 2px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 0.95em;
            transition: all 0.3s;
        }

        .form-field input:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 10px rgba(88, 166, 255, 0.3);
        }

        .form-field input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-guardar-horario {
            width: 100%;
            padding: 12px;
            background: linear-gradient(145deg, #238636, #2ea043);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-guardar-horario:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(35, 134, 54, 0.5);
        }

        .btn-guardar-horario:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-reentrenar {
            width: 100%;
            padding: 14px;
            background: linear-gradient(145deg, #8250df, #6e40c9);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin-top: 20px;
            box-shadow: 0 0 15px rgba(130, 80, 223, 0.5);
        }

        .btn-reentrenar:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(130, 80, 223, 0.8);
        }

        .info-box {
            background: rgba(88, 166, 255, 0.1);
            border: 2px solid #58a6ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            color: #c9d1d9;
            font-size: 0.9em;
        }

        /* ========== ESTILOS PARA KPIs Y DIAGRAMAS MLP ========== */
        
        .mlp-analytics-section {
            background: linear-gradient(145deg, #161b22 0%, #0d1117 100%);
            border: 2px solid #8250df;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 0 30px rgba(130, 80, 223, 0.3);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .kpi-card {
            background: rgba(22, 27, 34, 0.6);
            border: 2px solid #30363d;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            border-color: #8250df;
            box-shadow: 0 0 20px rgba(130, 80, 223, 0.4);
        }

        .kpi-label {
            color: #8b949e;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .kpi-value {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(135deg, #8250df, #6e40c9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 10px 0;
        }

        .kpi-subtitle {
            color: #58a6ff;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .architecture-diagram {
            background: rgba(22, 27, 34, 0.4);
            border: 2px solid #30363d;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
        }

        .layer-visualization {
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .layer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .layer-title {
            color: #58a6ff;
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .neuron-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .neuron {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8250df, #6e40c9);
            box-shadow: 0 0 15px rgba(130, 80, 223, 0.6);
            animation: pulse-neuron 2s ease-in-out infinite;
        }

        @keyframes pulse-neuron {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .layer-arrow {
            font-size: 2em;
            color: #58a6ff;
        }

        .prediction-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: rgba(22, 27, 34, 0.6);
            border-radius: 10px;
            overflow: hidden;
        }

        .prediction-table th {
            background: #8250df;
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 0.9em;
        }

        .prediction-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #30363d;
            color: #c9d1d9;
            font-size: 0.85em;
        }

        .prediction-table tr:hover {
            background: rgba(130, 80, 223, 0.1);
        }

        .relay-indicator {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .relay-indicator.on {
            background: #238636;
            color: white;
        }

        .relay-indicator.off {
            background: #21262d;
            color: #8b949e;
        }

        .progress-bar-container {
            width: 100%;
            height: 25px;
            background: #21262d;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
            border: 2px solid #30363d;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #238636, #2ea043);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
            transition: width 0.5s ease;
        }

        .chart-container-small {
            position: relative;
            height: 250px;
            margin: 15px 0;
        }

        /* ========== ESTILOS PARA EXPLICACI√ìN DE DECISIONES ========== */
        
        .explicacion-panel {
            background: linear-gradient(145deg, #161b22 0%, #0d1117 100%);
            border: 2px solid #f85149;
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 0 30px rgba(248, 81, 73, 0.3);
        }

        .explicacion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #30363d;
        }

        .btn-explicar {
            padding: 12px 24px;
            background: linear-gradient(145deg, #f85149, #da3633);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(248, 81, 73, 0.5);
        }

        .btn-explicar:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(248, 81, 73, 0.8);
        }

        .relay-explicacion {
            background: rgba(22, 27, 34, 0.6);
            border: 2px solid #30363d;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .relay-explicacion.activado {
            border-color: #238636;
            background: rgba(35, 134, 54, 0.1);
        }

        .relay-explicacion.desactivado {
            border-color: #6e7681;
            background: rgba(110, 118, 129, 0.05);
        }

        .relay-explicacion.error {
            border-color: #f85149;
            background: rgba(248, 81, 73, 0.1);
        }

        .explicacion-titulo {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .explicacion-nombre {
            font-size: 1.1em;
            font-weight: bold;
            color: #58a6ff;
        }

        .explicacion-estado {
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .explicacion-estado.on {
            background: #238636;
            color: white;
        }

        .explicacion-estado.off {
            background: #6e7681;
            color: white;
        }

        .confianza-bar {
            width: 100%;
            height: 30px;
            background: #21262d;
            border-radius: 8px;
            overflow: hidden;
            margin: 10px 0;
            border: 2px solid #30363d;
        }

        .confianza-fill {
            height: 100%;
            background: linear-gradient(90deg, #238636, #2ea043);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
            transition: width 0.5s ease;
        }

        .confianza-fill.baja {
            background: linear-gradient(90deg, #da3633, #f85149);
        }

        .razones-lista {
            list-style: none;
            padding: 0;
            margin: 15px 0 0 0;
        }

        .razones-lista li {
            padding: 8px 12px;
            margin-bottom: 6px;
            background: rgba(22, 27, 34, 0.4);
            border-radius: 6px;
            border-left: 3px solid #30363d;
            font-size: 0.9em;
        }

        .razones-lista li.ok {
            border-left-color: #238636;
        }

        .razones-lista li.problema {
            border-left-color: #f85149;
        }

        .veredicto-box {
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: bold;
            text-align: center;
        }

        .veredicto-box.correcto {
            background: rgba(35, 134, 54, 0.2);
            border: 2px solid #238636;
            color: #2ea043;
        }

        .veredicto-box.error {
            background: rgba(248, 81, 73, 0.2);
            border: 2px solid #f85149;
            color: #ff7b72;
        }

        .contexto-actual {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(22, 27, 34, 0.4);
            border-radius: 8px;
        }

        .contexto-item {
            text-align: center;
        }

        .contexto-label {
            color: #8b949e;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .contexto-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #58a6ff;
        }

        .info-box strong {
            color: #58a6ff;
        }

        .control-panel {
            background: linear-gradient(145deg, #161b22 0%, #0d1117 100%);
            border: 2px solid #388bfd;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 0 30px rgba(56, 139, 253, 0.3);
        }

        .mode-switch-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(22, 27, 34, 0.6);
            border-radius: 10px;
        }

        .mode-label {
            font-size: 1.2em;
            font-weight: bold;
            color: #c9d1d9;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 80px;
            height: 40px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #238636;
            transition: .4s;
            border-radius: 40px;
            box-shadow: 0 0 15px rgba(35, 134, 54, 0.5);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 32px;
            width: 32px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #d29922;
            box-shadow: 0 0 15px rgba(210, 153, 34, 0.7);
        }

        input:checked + .slider:before {
            transform: translateX(40px);
        }

        .manual-controls {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
            background: rgba(22, 27, 34, 0.4);
            border-radius: 10px;
        }

        .manual-controls.active {
            display: grid;
        }

        .relay-control {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background: linear-gradient(145deg, #21262d, #161b22);
            border-radius: 8px;
        }

        .relay-control-label {
            color: #8b949e;
            font-size: 0.9em;
            text-align: center;
        }

        .btn-relay {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        .btn-relay-off {
            background: linear-gradient(145deg, #21262d, #161b22);
            color: #8b949e;
            border: 2px solid #30363d;
        }

        .btn-relay-on {
            background: linear-gradient(145deg, #238636, #2ea043);
            color: white;
            box-shadow: 0 0 15px rgba(35, 134, 54, 0.5);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-login {
            background: linear-gradient(145deg, #161b22 0%, #0d1117 100%);
            border: 2px solid #8250df;
            border-radius: 16px;
            padding: 40px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 0 50px rgba(130, 80, 223, 0.5);
        }

        .modal-header h2 {
            color: #8250df;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            color: #c9d1d9;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 14px;
            background: #0d1117;
            border: 2px solid #30363d;
            border-radius: 8px;
            color: #c9d1d9;
            font-size: 1em;
        }

        .form-group input:focus {
            outline: none;
            border-color: #8250df;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn-modal {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1em;
        }

        .btn-login {
            background: linear-gradient(145deg, #8250df, #6e40c9);
            color: white;
            box-shadow: 0 0 15px rgba(130, 80, 223, 0.5);
        }

        .btn-cancel {
            background: #21262d;
            color: #8b949e;
            border: 2px solid #30363d;
        }

        .error-message {
            background: #da3633;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        .relay-status { 
            padding: 15px; 
            border-radius: 8px; 
            font-weight: bold; 
            margin-top: 10px; 
            text-align: center;
            transition: all 0.3s;
        }

        .relay-off { 
            background: linear-gradient(145deg, #21262d, #161b22);
            color: #484f58; 
        }

        .relay-on { 
            background: linear-gradient(145deg, #238636, #1a6d2b);
            color: white;
            box-shadow: 0 0 20px rgba(35, 134, 54, 0.6);
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(35, 134, 54, 0.6); }
            50% { box-shadow: 0 0 30px rgba(35, 134, 54, 0.9); }
        }

        .relay-icon {
            font-size: 1.5em;
            display: block;
            margin-bottom: 8px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .chart-card {
            background: linear-gradient(145deg, #161b22 0%, #0d1117 100%);
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            h1 { font-size: 1.8em; }
            .val { font-size: 2.5em; }
            .grid { grid-template-columns: 1fr; }
            .relay-config-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- MODAL LOGIN -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal-login">
            <div class="modal-header">
                <h2>üîê Acceso Administrativo</h2>
                <p style="color: #8b949e;">Ingresa tus credenciales</p>
            </div>
            
            <div id="loginError" class="error-message">
                ‚ö†Ô∏è Credenciales incorrectas
            </div>
            
            <form id="loginForm" onsubmit="return false;">
                <div class="form-group">
                    <label>üë§ Usuario</label>
                    <input type="text" id="username" placeholder="admin" required>
                </div>
                
                <div class="form-group">
                    <label>üîë Contrase√±a</label>
                    <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn-modal btn-cancel" onclick="cancelarLogin()">Cancelar</button>
                    <button type="submit" class="btn-modal btn-login">Iniciar Sesi√≥n</button>
                </div>
            </form>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üß† SISTEMA MLP - CONTROL INTELIGENTE</h1>
            <p style="color: #8b949e; font-size: 1.1em;">Red Neuronal con Horarios Configurables</p>
            
            <div class="status-bar">
                <div id="connection-badge" class="status-badge badge-offline">
                    <span>‚óè</span> <span>Conectando...</span>
                </div>
                <div id="mlp-badge" class="status-badge badge-mlp">
                    üß† MLP ACTIVO
                </div>
                <div id="mode-badge" class="status-badge badge-auto">
                    ü§ñ MODO AUTO
                </div>
                <div id="auth-badge" class="status-badge badge-auth" onclick="cerrarSesion()" style="display: none;">
                    üë§ ADMIN - Click para salir
                </div>
                <div class="status-badge" style="background: #1f6feb; color: white;">
                    ‚è±Ô∏è <span id="last-update">Sincronizando...</span>
                </div>
            </div>
        </div>

        <!-- ‚≠ê NUEVA SECCI√ìN: CONFIGURACI√ìN DE HORARIOS -->
        <div class="horarios-panel">
            <h2 class="section-title" style="margin-top: 0; border-color: #58a6ff;">‚è∞ Configuraci√≥n de Horarios y Condiciones</h2>
            
            <div class="info-box">
                <strong>üìå Importante:</strong> Despu√©s de modificar los horarios, debes hacer clic en "üîÑ Re-entrenar MLP" para que la red neuronal aprenda las nuevas configuraciones.
            </div>

            <div class="relay-config-grid" id="horariosConfigGrid">
                <!-- Se llenar√° din√°micamente con JavaScript -->
            </div>

            <button class="btn-reentrenar" onclick="reentrenarConNuevosHorarios()">
                üîÑ Re-entrenar MLP con Nuevos Horarios
            </button>
        </div>

        <!-- PANEL DE CONTROL -->
        <div class="control-panel">
            <h2 class="section-title" style="margin-top: 0;">üéõÔ∏è Panel de Control del Sistema</h2>
            
            <div class="mode-switch-container">
                <span class="mode-label">ü§ñ AUTOM√ÅTICO (MLP)</span>
                <label class="switch">
                    <input type="checkbox" id="modeSwitch" onchange="cambiarModo()">
                    <span class="slider"></span>
                </label>
                <span class="mode-label">üéÆ MANUAL</span>
            </div>

            <div id="manualControls" class="manual-controls">
                <div class="relay-control">
                    <div class="relay-control-label">üîß MOTOR AC</div>
                    <button id="btnRelay1" class="btn-relay btn-relay-off" onclick="toggleRelay(1)">OFF</button>
                </div>
                <div class="relay-control">
                    <div class="relay-control-label">üí° FOCO 1</div>
                    <button id="btnRelay2" class="btn-relay btn-relay-off" onclick="toggleRelay(2)">OFF</button>
                </div>
                <div class="relay-control">
                    <div class="relay-control-label">üí° FOCO 2</div>
                    <button id="btnRelay3" class="btn-relay btn-relay-off" onclick="toggleRelay(3)">OFF</button>
                </div>
                <div class="relay-control">
                    <div class="relay-control-label">üîå RESERVA</div>
                    <button id="btnRelay4" class="btn-relay btn-relay-off" onclick="toggleRelay(4)">OFF</button>
                </div>
            </div>
        </div>

        <!-- SENSORES -->
        <h2 class="section-title">üìä Lecturas de Sensores en Tiempo Real</h2>
        <div class="grid">
            <div class="card">
                <div class="lbl">üå°Ô∏è TEMPERATURA</div>
                <div class="val">
                    <span id="temp">--</span><span class="unit">¬∞C</span>
                </div>
            </div>
            
            <div class="card">
                <div class="lbl">üíß HUMEDAD RELATIVA</div>
                <div class="val">
                    <span id="hum">--</span><span class="unit">%</span>
                </div>
            </div>

            <div class="card">
                <div class="lbl">‚è∞ HORA ACTUAL</div>
                <div class="val" style="font-size: 2.5em;">
                    <span id="hora">--:--</span>
                </div>
            </div>
        </div>

        <!-- RELAYS -->
        <h2 class="section-title">üîå Estado de Rel√©s</h2>
        <div class="grid">
            <div class="card">
                <div class="lbl">RELAY 1 - Motor AC 220V</div>
                <div id="relay1" class="relay-status relay-off">
                    <span class="relay-icon">üîß</span>
                    APAGADO
                </div>
            </div>
            <div class="card">
                <div class="lbl">RELAY 2 - Foco 1</div>
                <div id="relay2" class="relay-status relay-off">
                    <span class="relay-icon">üí°</span>
                    APAGADO
                </div>
            </div>
            <div class="card">
                <div class="lbl">RELAY 3 - Foco 2</div>
                <div id="relay3" class="relay-status relay-off">
                    <span class="relay-icon">üí°</span>
                    APAGADO
                </div>
            </div>
            <div class="card">
                <div class="lbl">RELAY 4 - Reserva</div>
                <div id="relay4" class="relay-status relay-off">
                    <span class="relay-icon">üîå</span>
                    APAGADO
                </div>
            </div>
        </div>

        <!-- GR√ÅFICOS -->
        <h2 class="section-title">üìâ Monitoreo en Tiempo Real</h2>
        
        <div class="chart-card">
            <h3 style="color: #58a6ff; font-size: 1.3em; margin-bottom: 20px;">üìä Comparativa Temp vs Humedad</h3>
            <div class="chart-container">
                <canvas id="chartComparativo"></canvas>
            </div>
        </div>
        <!-- ========== SECCI√ìN MLP ANALYTICS ========== -->
        <div class="mlp-analytics-section">
            <h2 class="section-title" style="margin-top: 0; border-color: #8250df;">üß† An√°lisis Detallado de la Red Neuronal MLP</h2>
            
            <!-- KPIs Principales -->
            <div class="kpi-grid" id="mlpKpisGrid">
                <div class="kpi-card">
                    <div class="kpi-label">üéØ Accuracy</div>
                    <div class="kpi-value"><span id="kpi-accuracy">--</span><span style="font-size: 0.5em;">%</span></div>
                    <div class="kpi-subtitle">Precisi√≥n del Modelo</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-label">üìä Muestras</div>
                    <div class="kpi-value" id="kpi-samples">--</div>
                    <div class="kpi-subtitle">Dataset de Entrenamiento</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-label">üîÑ Iteraciones</div>
                    <div class="kpi-value" id="kpi-iterations">--</div>
                    <div class="kpi-subtitle">Ciclos de Aprendizaje</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-label">‚öôÔ∏è Par√°metros</div>
                    <div class="kpi-value" id="kpi-parameters">--</div>
                    <div class="kpi-subtitle">Pesos Neuronales</div>
                </div>
            </div>

            <!-- Arquitectura Visual -->
            <div class="architecture-diagram">
                <h3 style="color: #58a6ff; margin-bottom: 20px; text-align: center;">üèóÔ∏è Arquitectura de la Red Neuronal</h3>
                
                <div class="layer-visualization">
                    <div class="layer">
                        <div class="layer-title">ENTRADA</div>
                        <div class="neuron-group">
                            <div class="neuron" title="Temperatura"></div>
                            <div class="neuron" title="Humedad"></div>
                            <div class="neuron" title="Hora"></div>
                        </div>
                        <small style="color: #8b949e;">3 neuronas</small>
                    </div>

                    <div class="layer-arrow">‚Üí</div>

                    <div class="layer">
                        <div class="layer-title">CAPA OCULTA 1</div>
                        <div class="neuron-group" id="layer1Neurons">
                            <!-- Se generar√°n 32 neuronas con JS -->
                        </div>
                        <small style="color: #8b949e;">32 neuronas (ReLU)</small>
                    </div>

                    <div class="layer-arrow">‚Üí</div>

                    <div class="layer">
                        <div class="layer-title">CAPA OCULTA 2</div>
                        <div class="neuron-group" id="layer2Neurons">
                            <!-- Se generar√°n 16 neuronas con JS -->
                        </div>
                        <small style="color: #8b949e;">16 neuronas (ReLU)</small>
                    </div>

                    <div class="layer-arrow">‚Üí</div>

                    <div class="layer">
                        <div class="layer-title">CAPA OCULTA 3</div>
                        <div class="neuron-group" id="layer3Neurons">
                            <!-- Se generar√°n 8 neuronas con JS -->
                        </div>
                        <small style="color: #8b949e;">8 neuronas (ReLU)</small>
                    </div>

                    <div class="layer-arrow">‚Üí</div>

                    <div class="layer">
                        <div class="layer-title">SALIDA</div>
                        <div class="neuron-group">
                            <div class="neuron" title="Relay 1" style="background: linear-gradient(135deg, #238636, #2ea043);"></div>
                            <div class="neuron" title="Relay 2" style="background: linear-gradient(135deg, #58a6ff, #388bfd);"></div>
                            <div class="neuron" title="Relay 3" style="background: linear-gradient(135deg, #d29922, #f0883e);"></div>
                            <div class="neuron" title="Relay 4" style="background: linear-gradient(135deg, #da3633, #f85149);"></div>
                        </div>
                        <small style="color: #8b949e;">4 rel√©s</small>
                    </div>
                </div>
            </div>

            <!-- Gr√°ficos de Distribuci√≥n -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-top: 30px;">
                <div class="chart-card">
                    <h3 style="color: #58a6ff; font-size: 1.1em; margin-bottom: 15px;">üìä Distribuci√≥n Dataset ON/OFF</h3>
                    <div class="chart-container-small">
                        <canvas id="chartDatasetDistribution"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3 style="color: #58a6ff; font-size: 1.1em; margin-bottom: 15px;">üî¢ Activaciones por Relay</h3>
                    <div class="chart-container-small">
                        <canvas id="chartRelayActivations"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3 style="color: #58a6ff; font-size: 1.1em; margin-bottom: 15px;">‚ö° Activaciones Simult√°neas</h3>
                    <div class="chart-container-small">
                        <canvas id="chartSimultaneous"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tabla de Predicciones Recientes -->
            <h3 style="color: #58a6ff; margin-top: 30px; margin-bottom: 15px;">üìã √öltimas 10 Predicciones del MLP</h3>
            <div style="overflow-x: auto;">
                <table class="prediction-table" id="predictionsTable">
                    <thead>
                        <tr>
                            <th>‚è∞ Hora</th>
                            <th>üå°Ô∏è Temp</th>
                            <th>üíß Hum</th>
                            <th>üîß R1</th>
                            <th>üí° R2</th>
                            <th>üí° R3</th>
                            <th>üîå R4</th>
                            <th>üìä Total Activos</th>
                            <th>üéÆ Modo</th>
                        </tr>
                    </thead>
                    <tbody id="predictionsTableBody">
                        <tr><td colspan="9" style="text-align: center; color: #8b949e;">Cargando predicciones...</td></tr>
                    </tbody>
                </table>
            </div>
            <!-- Panel de Explicaci√≥n de Decisiones -->
            <div class="explicacion-panel" id="explicacionPanel" style="display: none;">
                <div class="explicacion-header">
                    <h3 style="color: #f85149; margin: 0;">üîç Explicaci√≥n Detallada de Decisiones</h3>
                    <button class="btn-explicar" onclick="cerrarExplicacion()">‚úñ Cerrar</button>
                </div>

                <div class="contexto-actual" id="contextoActual">
                    <!-- Se llenar√° con JavaScript -->
                </div>

                <div id="explicacionesContainer">
                    <!-- Se llenar√° con JavaScript -->
                </div>
            </div>

            <!-- Bot√≥n para abrir explicaci√≥n -->
            <button class="btn-explicar" onclick="explicarUltimaPrediccion()" style="width: 100%; margin-top: 20px;">
                üîç Explicar √öltima Predicci√≥n del MLP
            </button>
        </div>
    </div>

    <script>
        // ========== VARIABLES GLOBALES ==========
        let errorConsecutivos = 0;
        let modoActual = 'AUTO';
        let estadosManuales = { relay1: false, relay2: false, relay3: false, relay4: false };
        let adminAutenticado = false;
        let chartComparativo;
        let chartDatasetDist, chartRelayAct, chartSimultaneous;
        let mlpMetricasDetalladas = null;
        let horariosActuales = {};

        // ========== FUNCIONES DE HORARIOS ==========
        
        function decimalAHora(decimal) {
            const horas = Math.floor(decimal);
            const minutos = Math.round((decimal % 1) * 60);
            return `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;
        }

        function horaADecimal(horaStr) {
            const [horas, minutos] = horaStr.split(':').map(Number);
            return horas + (minutos / 60);
        }

        async function cargarHorarios() {
            try {
                const response = await fetch('/api/horarios');
                const data = await response.json();
                horariosActuales = data;
                renderizarConfiguracionHorarios();
            } catch (error) {
                console.error('Error cargando horarios:', error);
            }
        }

        function renderizarConfiguracionHorarios() {
            const grid = document.getElementById('horariosConfigGrid');
            grid.innerHTML = '';

            const relays = ['relay1', 'relay2', 'relay3', 'relay4'];
            relays.forEach(relayKey => {
                const config = horariosActuales[relayKey];
                const relayNum = relayKey.slice(-1);
                
                const card = document.createElement('div');
                card.className = `relay-config-card ${config.habilitado ? 'habilitado' : ''}`;
                card.id = `config-${relayKey}`;
                
                card.innerHTML = `
                    <div class="relay-config-header">
                        <div class="relay-config-title">
                            ${getIconoRelay(relayKey)} ${config.nombre}
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-${relayKey}" 
                                   ${config.habilitado ? 'checked' : ''}
                                   onchange="toggleHabilitado('${relayKey}')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="form-group-inline">
                        <div class="form-field">
                            <label>‚è∞ Hora Inicio</label>
                            <input type="time" id="hora-inicio-${relayKey}" 
                                   value="${decimalAHora(config.hora_inicio)}"
                                   ${!config.habilitado ? 'disabled' : ''}>
                        </div>
                        <div class="form-field">
                            <label>‚è∞ Hora Fin</label>
                            <input type="time" id="hora-fin-${relayKey}" 
                                   value="${decimalAHora(config.hora_fin)}"
                                   ${!config.habilitado ? 'disabled' : ''}>
                        </div>
                    </div>

                    <div class="form-group-inline">
                        <div class="form-field">
                            <label>üå°Ô∏è Temp M√≠n (¬∞C)</label>
                            <input type="number" step="0.1" id="temp-min-${relayKey}" 
                                   value="${config.temp_min}"
                                   ${!config.habilitado ? 'disabled' : ''}>
                        </div>
                        <div class="form-field">
                            <label>üå°Ô∏è Temp M√°x (¬∞C)</label>
                            <input type="number" step="0.1" id="temp-max-${relayKey}" 
                                   value="${config.temp_max}"
                                   ${!config.habilitado ? 'disabled' : ''}>
                        </div>
                    </div>

                    <div class="form-group-inline">
                        <div class="form-field">
                            <label>üíß Humedad M√≠n (%)</label>
                            <input type="number" step="0.1" id="hum-min-${relayKey}" 
                                   value="${config.hum_min}"
                                   ${!config.habilitado ? 'disabled' : ''}>
                        </div>
                        <div class="form-field">
                            <label>üíß Humedad M√°x (%)</label>
                            <input type="number" step="0.1" id="hum-max-${relayKey}" 
                                   value="${config.hum_max}"
                                   ${!config.habilitado ? 'disabled' : ''}>
                        </div>
                    </div>

                    <button class="btn-guardar-horario" onclick="guardarHorario('${relayKey}')"
                            ${!config.habilitado ? 'disabled' : ''}>
                        üíæ Guardar Configuraci√≥n
                    </button>
                `;
                
                grid.appendChild(card);
            });
        }

        function getIconoRelay(relayKey) {
            const iconos = {
                'relay1': 'üîß',
                'relay2': 'üí°',
                'relay3': 'üí°',
                'relay4': 'üîå'
            };
            return iconos[relayKey] || 'üîå';
        }

        function toggleHabilitado(relayKey) {
            const checkbox = document.getElementById(`toggle-${relayKey}`);
            const card = document.getElementById(`config-${relayKey}`);
            const inputs = card.querySelectorAll('input:not([type="checkbox"])');
            const btnGuardar = card.querySelector('.btn-guardar-horario');
            
            if (checkbox.checked) {
                card.classList.add('habilitado');
                inputs.forEach(input => input.disabled = false);
                btnGuardar.disabled = false;
            } else {
                card.classList.remove('habilitado');
                inputs.forEach(input => input.disabled = true);
                btnGuardar.disabled = true;
            }
        }

        async function guardarHorario(relayKey) {
            if (!adminAutenticado) {
                mostrarModalLogin();
                return;
            }

            const config = {
                relay: relayKey,
                habilitado: document.getElementById(`toggle-${relayKey}`).checked,
                hora_inicio: horaADecimal(document.getElementById(`hora-inicio-${relayKey}`).value),
                hora_fin: horaADecimal(document.getElementById(`hora-fin-${relayKey}`).value),
                temp_min: parseFloat(document.getElementById(`temp-min-${relayKey}`).value),
                temp_max: parseFloat(document.getElementById(`temp-max-${relayKey}`).value),
                hum_min: parseFloat(document.getElementById(`hum-min-${relayKey}`).value),
                hum_max: parseFloat(document.getElementById(`hum-max-${relayKey}`).value)
            };

            // Validaciones
            if (config.hora_inicio >= config.hora_fin) {
                alert('‚ö†Ô∏è La hora de inicio debe ser menor que la hora de fin');
                return;
            }
            if (config.temp_min >= config.temp_max) {
                alert('‚ö†Ô∏è La temperatura m√≠nima debe ser menor que la m√°xima');
                return;
            }
            if (config.hum_min >= config.hum_max) {
                alert('‚ö†Ô∏è La humedad m√≠nima debe ser menor que la m√°xima');
                return;
            }

            try {
                const response = await fetch('/api/horarios', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(config)
                });

                const data = await response.json();

                if (data.ok) {
                    alert(`‚úÖ Configuraci√≥n guardada para ${horariosActuales[relayKey].nombre}\n\n` +
                          `‚ö†Ô∏è Recuerda re-entrenar el MLP para aplicar los cambios.`);
                    horariosActuales = data.horarios;
                } else if (data.requiere_auth) {
                    mostrarModalLogin();
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error guardando horario:', error);
                alert('Error de conexi√≥n al guardar horario');
            }
        }

        async function reentrenarConNuevosHorarios() {
            if (!adminAutenticado) {
                mostrarModalLogin();
                return;
            }

            if (!confirm('üîÑ ¬øRe-entrenar la Red Neuronal con los nuevos horarios?\n\n' +
                         'Esto har√° que el MLP aprenda las nuevas configuraciones de tiempo y condiciones.\n\n' +
                         '‚è±Ô∏è El proceso puede tardar unos segundos.')) {
                return;
            }

            const btnReentrenar = document.querySelector('.btn-reentrenar');
            btnReentrenar.disabled = true;
            btnReentrenar.textContent = '‚è≥ Re-entrenando MLP...';

            try {
                const response = await fetch('/api/mlp/entrenar', {
                    method: 'POST',
                    credentials: 'include'
                });

                const resultado = await response.json();

                if (resultado.success) {
                    alert(`‚úÖ Red Neuronal Re-entrenada con √âxito!\n\n` +
                          `üìä Nuevas M√©tricas:\n` +
                          `- Accuracy: ${resultado.metricas.accuracy}%\n` +
                          `- Muestras: ${resultado.metricas.samples_trained}\n` +
                          `- Iteraciones: ${resultado.metricas.iterations}\n` +
                          `- Tiempo: ${resultado.metricas.training_time}s\n\n` +
                          `‚ú® El sistema ahora usar√° los nuevos horarios configurados.`);
                    actualizarEstadoMLP();
                } else if (resultado.requiere_auth) {
                    mostrarModalLogin();
                } else {
                    alert(`‚ùå Error en re-entrenamiento:\n${resultado.mensaje}`);
                }
            } catch (error) {
                console.error('Error re-entrenando:', error);
                alert('Error de conexi√≥n al re-entrenar el modelo');
            } finally {
                btnReentrenar.disabled = false;
                btnReentrenar.textContent = 'üîÑ Re-entrenar MLP con Nuevos Horarios';
            }
        }

        // ========== AUTENTICACI√ìN ==========
        function mostrarModalLogin() {
            document.getElementById('loginModal').classList.add('active');
            document.getElementById('username').focus();
        }

        function ocultarModalLogin() {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').classList.remove('active');
        }

        function cancelarLogin() {
            ocultarModalLogin();
            document.getElementById('modeSwitch').checked = false;
        }

        async function intentarLogin(usuario, password) {
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ usuario, password })
                });

                const data = await response.json();

                if (data.ok) {
                    adminAutenticado = true;
                    ocultarModalLogin();
                    document.getElementById('auth-badge').style.display = 'flex';
                    console.log('‚úÖ Login exitoso');
                    return await cambiarModoConAuth('MANUAL');
                } else {
                    document.getElementById('loginError').classList.add('active');
                    setTimeout(() => {
                        document.getElementById('loginError').classList.remove('active');
                    }, 3000);
                    return false;
                }
            } catch (error) {
                console.error('Error en login:', error);
                alert('Error de conexi√≥n al servidor');
                return false;
            }
        }

        async function cerrarSesion() {
            if (!confirm('¬øCerrar sesi√≥n de administrador?')) return;

            try {
                await fetch('/api/auth/logout', { 
                    method: 'POST', 
                    credentials: 'include' 
                });
                adminAutenticado = false;
                document.getElementById('auth-badge').style.display = 'none';
                await cambiarModoConAuth('AUTO');
                document.getElementById('modeSwitch').checked = false;
                console.log('‚úÖ Sesi√≥n cerrada');
            } catch (error) {
                console.error('Error cerrando sesi√≥n:', error);
            }
        }

        async function verificarSesionActiva() {
            try {
                const response = await fetch('/api/auth/verificar', { credentials: 'include' });
                const data = await response.json();
                if (data.autenticado) {
                    adminAutenticado = true;
                    document.getElementById('auth-badge').style.display = 'flex';
                    console.log('‚úÖ Sesi√≥n administrativa activa');
                }
            } catch (error) {
                console.error('Error verificando sesi√≥n:', error);
            }
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await intentarLogin(
                document.getElementById('username').value,
                document.getElementById('password').value
            );
        });

        // ========== CONTROL DE MODO ==========
        async function cambiarModo() {
            const switchElement = document.getElementById('modeSwitch');
            const nuevoModo = switchElement.checked ? 'MANUAL' : 'AUTO';
            
            if (nuevoModo === 'MANUAL' && !adminAutenticado) {
                switchElement.checked = false;
                mostrarModalLogin();
                return;
            }
            
            await cambiarModoConAuth(nuevoModo);
        }

        async function cambiarModoConAuth(nuevoModo) {
            try {
                const response = await fetch('/api/modo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ modo: nuevoModo })
                });

                const data = await response.json();

                if (data.ok) {
                    modoActual = nuevoModo;
                    actualizarUIdelModo(nuevoModo);
                    console.log(`‚úì Modo cambiado a ${nuevoModo}`);
                    return true;
                } else if (data.requiere_auth) {
                    mostrarModalLogin();
                    return false;
                } else {
                    alert(`Error: ${data.error}`);
                    return false;
                }
            } catch (error) {
                console.error('Error cambiando modo:', error);
                alert('Error de conexi√≥n al cambiar modo');
                return false;
            }
        }

        function actualizarUIdelModo(modo) {
            const badge = document.getElementById('mode-badge');
            const controls = document.getElementById('manualControls');
            const switchElement = document.getElementById('modeSwitch');
            
            if (modo === 'MANUAL') {
                badge.className = 'status-badge badge-manual';
                badge.innerHTML = 'üéÆ MODO MANUAL';
                controls.classList.add('active');
                switchElement.checked = true;
            } else {
                badge.className = 'status-badge badge-auto';
                badge.innerHTML = 'ü§ñ MODO AUTO';
                controls.classList.remove('active');
                switchElement.checked = false;
            }
        }

        // ========== CONTROL MANUAL DE REL√âS ==========
        async function toggleRelay(num) {
            if (modoActual !== 'MANUAL') {
                alert('‚ö†Ô∏è Debes estar en modo MANUAL para controlar los rel√©s');
                return;
            }

            if (!adminAutenticado) {
                mostrarModalLogin();
                return;
            }

            const relay = `relay${num}`;
            const nuevoEstado = !estadosManuales[relay];
            
            try {
                const response = await fetch('/api/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ relay, estado: nuevoEstado })
                });

                const data = await response.json();

                if (data.ok) {
                    estadosManuales[relay] = nuevoEstado;
                    actualizarBotonRelay(num, nuevoEstado);
                    console.log(`‚úì ${relay} ‚Üí ${nuevoEstado ? 'ON' : 'OFF'}`);
                } else if (data.requiere_auth) {
                    mostrarModalLogin();
                } else {
                    alert(`Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error controlando relay:', error);
                alert('Error de conexi√≥n al controlar relay');
            }
        }

        function actualizarBotonRelay(num, estado) {
            const btn = document.getElementById(`btnRelay${num}`);
            btn.className = estado ? 'btn-relay btn-relay-on' : 'btn-relay btn-relay-off';
            btn.textContent = estado ? 'ON' : 'OFF';
        }

        // ========== ACTUALIZACI√ìN DE UI ==========
        function actualizarRelay(id, activo) {
            const el = document.getElementById(id);
            el.className = activo ? 'relay-status relay-on' : 'relay-status relay-off';
            el.innerHTML = `<span class="relay-icon">${activo ? '‚úÖ' : '‚ùå'}</span>${activo ? 'ENCENDIDO' : 'APAGADO'}`;
        }

        function actualizarDashboard() {
            fetch('/api/estado')
                .then(r => {
                    if (!r.ok) throw new Error('Error de red');
                    return r.json();
                })
                .then(data => {
                    errorConsecutivos = 0;

                    const badge = document.getElementById('connection-badge');
                    badge.className = data.conectado ? 'status-badge badge-online' : 'status-badge badge-offline';
                    badge.innerHTML = data.conectado ? '<span>‚óè</span> <span>ESP32 Conectado</span>' : '<span>‚óè</span> <span>Desconectado</span>';

                    if (data.modo !== modoActual) {
                        modoActual = data.modo;
                        actualizarUIdelModo(data.modo);
                    }

                    if (data.modo === 'MANUAL') {
                        estadosManuales = {
                            relay1: data.relay1,
                            relay2: data.relay2,
                            relay3: data.relay3,
                            relay4: data.relay4
                        };
                        actualizarBotonRelay(1, data.relay1);
                        actualizarBotonRelay(2, data.relay2);
                        actualizarBotonRelay(3, data.relay3);
                        actualizarBotonRelay(4, data.relay4);
                    }

                    document.getElementById('temp').textContent = data.temperatura.toFixed(1);
                    document.getElementById('hum').textContent = data.humedad.toFixed(1);
                    
                    const hora = Math.floor(data.hora_actual || 0);
                    const minutos = Math.round(((data.hora_actual || 0) % 1) * 60);
                    document.getElementById('hora').textContent = `${String(hora).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;

                    document.getElementById('last-update').textContent = data.ultima_actualizacion || 'Esperando...';

                    actualizarRelay('relay1', data.relay1);
                    actualizarRelay('relay2', data.relay2);
                    actualizarRelay('relay3', data.relay3);
                    actualizarRelay('relay4', data.relay4);
                })
                .catch(err => {
                    console.error('Error actualizando dashboard:', err);
                    errorConsecutivos++;
                    
                    if (errorConsecutivos > 5) {
                        const badge = document.getElementById('connection-badge');
                        badge.className = 'status-badge badge-offline';
                        badge.innerHTML = '<span>‚óè</span> <span>Error de Conexi√≥n</span>';
                    }
                });
        }

        function actualizarEstadoMLP() {
            fetch('/api/mlp/estado')
                .then(r => r.json())
                .then(data => {
                    if (data.entrenado) {
                        const mlpBadge = document.getElementById('mlp-badge');
                        mlpBadge.innerHTML = `üß† MLP: ${data.metricas.accuracy.toFixed(1)}%`;
                    }
                })
                .catch(err => console.error('Error actualizando estado MLP:', err));
        }

        // ========== GR√ÅFICOS ==========
        function inicializarGraficos() {
            const configComun = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        labels: { color: '#c9d1d9', font: { size: 12 } }
                    }
                },
                animation: {
                    duration: 750
                }
            };

            chartComparativo = new Chart(document.getElementById('chartComparativo'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Temperatura (¬∞C)',
                            data: [],
                            borderColor: '#58a6ff',
                            backgroundColor: 'rgba(88, 166, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y',
                            fill: true
                        },
                        {
                            label: 'Humedad (%)',
                            data: [],
                            borderColor: '#2ea043',
                            backgroundColor: 'rgba(46, 160, 67, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1',
                            fill: true
                        }
                    ]
                },
                options: {
                    ...configComun,
                    scales: {
                        x: { 
                            ticks: { color: '#8b949e', maxRotation: 45 }, 
                            grid: { color: '#30363d' } 
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: { color: '#58a6ff' },
                            grid: { color: '#30363d' },
                            title: { display: true, text: 'Temperatura (¬∞C)', color: '#58a6ff' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { color: '#2ea043' },
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'Humedad (%)', color: '#2ea043' }
                        }
                    }
                }
            });
        }
        // ========== FUNCIONES PARA MLP ANALYTICS ==========

        function inicializarGraficosMLPAnalytics() {
            // Gr√°fico de Distribuci√≥n Dataset
            chartDatasetDist = new Chart(document.getElementById('chartDatasetDistribution'), {
                type: 'doughnut',
                data: {
                    labels: ['Muestras ON', 'Muestras OFF'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#238636', '#da3633'],
                        borderWidth: 2,
                        borderColor: '#0d1117'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#c9d1d9', font: { size: 11 } }
                        }
                    }
                }
            });

            // Gr√°fico de Activaciones por Relay
            chartRelayAct = new Chart(document.getElementById('chartRelayActivations'), {
                type: 'bar',
                data: {
                    labels: ['Relay 1', 'Relay 2', 'Relay 3', 'Relay 4'],
                    datasets: [{
                        label: 'Activaciones (%)',
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#238636', '#58a6ff', '#d29922', '#da3633'],
                        borderWidth: 2,
                        borderColor: '#0d1117'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { ticks: { color: '#8b949e' }, grid: { color: '#30363d' } },
                        y: { 
                            ticks: { color: '#8b949e' }, 
                            grid: { color: '#30363d' },
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Gr√°fico de Activaciones Simult√°neas
            chartSimultaneous = new Chart(document.getElementById('chartSimultaneous'), {
                type: 'bar',
                data: {
                    labels: ['0 Activos', '1 Activo', '2 Activos', '3 Activos', '4 Activos'],
                    datasets: [{
                        label: 'Cantidad de Muestras',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: '#8250df',
                        borderWidth: 2,
                        borderColor: '#0d1117'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { ticks: { color: '#8b949e' }, grid: { color: '#30363d' } },
                        y: { ticks: { color: '#8b949e' }, grid: { color: '#30363d' }, beginAtZero: true }
                    }
                }
            });
        }

        async function actualizarMLPAnalytics() {
            try {
                const response = await fetch('/api/mlp/metricas-detalladas');
                const data = await response.json();

                if (!data.entrenado) {
                    console.log('MLP no entrenado a√∫n');
                    return;
                }

                mlpMetricasDetalladas = data;

                // Actualizar KPIs
                document.getElementById('kpi-accuracy').textContent = data.metricas_generales.accuracy.toFixed(1);
                document.getElementById('kpi-samples').textContent = data.dataset.total_muestras;
                document.getElementById('kpi-iterations').textContent = data.metricas_generales.iterations;
                document.getElementById('kpi-parameters').textContent = data.arquitectura.total_parametros.toLocaleString();

                // Actualizar gr√°fico de distribuci√≥n ON/OFF
                chartDatasetDist.data.datasets[0].data = [
                    data.dataset.muestras_on,
                    data.dataset.muestras_off
                ];
                chartDatasetDist.update('none');

                // Actualizar gr√°fico de activaciones por relay
                const porcentajes = data.activaciones_por_relay.map(r => r.porcentaje);
                chartRelayAct.data.datasets[0].data = porcentajes;
                chartRelayAct.update('none');

                // Actualizar gr√°fico de activaciones simult√°neas
                const simultaneas = data.distribucion_simultaneas;
                chartSimultaneous.data.datasets[0].data = [
                    simultaneas['0_activos'].count,
                    simultaneas['1_activos'].count,
                    simultaneas['2_activos'].count,
                    simultaneas['3_activos'].count,
                    simultaneas['4_activos'].count
                ];
                chartSimultaneous.update('none');

            } catch (error) {
                console.error('Error actualizando MLP Analytics:', error);
            }
        }

        async function actualizarTablaPrediciones() {
            try {
                const response = await fetch('/api/historial-predicciones');
                const data = await response.json();

                const tbody = document.getElementById('predictionsTableBody');
                
                if (data.predicciones.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #8b949e;">No hay predicciones a√∫n</td></tr>';
                    return;
                }

                // Mostrar √∫ltimas 10
                const ultimas10 = data.predicciones.slice(-10).reverse();

                tbody.innerHTML = ultimas10.map(pred => `
                    <tr>
                        <td>${pred.hora_legible}</td>
                        <td>${pred.temperatura}¬∞C</td>
                        <td>${pred.humedad}%</td>
                        <td><span class="relay-indicator ${pred.relay1 ? 'on' : 'off'}">${pred.relay1 ? 'ON' : 'OFF'}</span></td>
                        <td><span class="relay-indicator ${pred.relay2 ? 'on' : 'off'}">${pred.relay2 ? 'ON' : 'OFF'}</span></td>
                        <td><span class="relay-indicator ${pred.relay3 ? 'on' : 'off'}">${pred.relay3 ? 'ON' : 'OFF'}</span></td>
                        <td><span class="relay-indicator ${pred.relay4 ? 'on' : 'off'}">${pred.relay4 ? 'ON' : 'OFF'}</span></td>
                        <td style="text-align: center; font-weight: bold; color: #58a6ff;">${pred.total_activos}</td>
                        <td><span style="color: ${pred.modo === 'AUTO' ? '#238636' : '#d29922'};">${pred.modo}</span></td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error actualizando tabla de predicciones:', error);
            }
        }

        function generarNeuronasVisuales(containerId, cantidad) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            // Mostrar solo una representaci√≥n visual (m√°ximo 8 neuronas visibles)
            const neuronasVisibles = Math.min(cantidad, 8);
            
            for (let i = 0; i < neuronasVisibles; i++) {
                const neuron = document.createElement('div');
                neuron.className = 'neuron';
                neuron.style.animationDelay = `${i * 0.1}s`;
                container.appendChild(neuron);
            }
        }

        // ========== FUNCIONES PARA EXPLICACI√ìN DE DECISIONES ==========

        async function explicarUltimaPrediccion() {
            try {
                const response = await fetch('/api/mlp/explicar-ultima');
                const data = await response.json();

                if (data.error) {
                    alert(`‚ö†Ô∏è ${data.error}`);
                    return;
                }

                mostrarExplicacion(data);

            } catch (error) {
                console.error('Error obteniendo explicaci√≥n:', error);
                alert('Error al obtener la explicaci√≥n');
            }
        }

        function mostrarExplicacion(data) {
            const panel = document.getElementById('explicacionPanel');
            const contextoDiv = document.getElementById('contextoActual');
            const container = document.getElementById('explicacionesContainer');

            // Mostrar contexto actual
            contextoDiv.innerHTML = `
                <div class="contexto-item">
                    <div class="contexto-label">üå°Ô∏è Temperatura</div>
                    <div class="contexto-value">${data.temperatura.toFixed(1)}¬∞C</div>
                </div>
                <div class="contexto-item">
                    <div class="contexto-label">üíß Humedad</div>
                    <div class="contexto-value">${data.humedad.toFixed(1)}%</div>
                </div>
                <div class="contexto-item">
                    <div class="contexto-label">‚è∞ Hora</div>
                    <div class="contexto-value">${data.hora_legible}</div>
                </div>
                <div class="contexto-item">
                    <div class="contexto-label">üìÖ Timestamp</div>
                    <div class="contexto-value" style="font-size: 0.9em;">${data.timestamp}</div>
                </div>
            `;

            // Generar explicaciones por relay
            container.innerHTML = data.explicaciones.map(exp => {
                const claseEstado = exp.activado ? 'activado' : 'desactivado';
                const claseError = exp.tipo.includes('falso') ? 'error' : '';
                
                const confianzaClase = exp.confianza >= 50 ? '' : 'baja';

                return `
                    <div class="relay-explicacion ${claseEstado} ${claseError}">
                        <div class="explicacion-titulo">
                            <div class="explicacion-nombre">
                                ${getIconoRelay(exp.relay)} ${exp.nombre}
                            </div>
                            <div class="explicacion-estado ${exp.activado ? 'on' : 'off'}">
                                ${exp.activado ? 'ON' : 'OFF'}
                            </div>
                        </div>

                        <div>
                            <small style="color: #8b949e;">Confianza del Modelo:</small>
                            <div class="confianza-bar">
                                <div class="confianza-fill ${confianzaClase}" style="width: ${exp.confianza}%">
                                    ${exp.confianza.toFixed(1)}%
                                </div>
                            </div>
                        </div>

                        <ul class="razones-lista">
                            ${exp.razones.map(razon => {
                                const esProblema = razon.includes('‚ùå') || razon.includes('‚ùÑÔ∏è') || 
                                                  razon.includes('üî•') || razon.includes('üèúÔ∏è') || 
                                                  razon.includes('üíß') || razon.includes('‚è∞');
                                return `<li class="${esProblema ? 'problema' : 'ok'}">${razon}</li>`;
                            }).join('')}
                        </ul>

                        <div class="veredicto-box ${exp.tipo.includes('correcto') ? 'correcto' : 'error'}">
                            ${exp.veredicto}
                        </div>
                    </div>
                `;
            }).join('');

            // Mostrar panel con animaci√≥n
            panel.style.display = 'block';
            panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function cerrarExplicacion() {
            const panel = document.getElementById('explicacionPanel');
            panel.style.display = 'none';
        }

        function actualizarGraficos() {
            fetch('/api/grafico-datos')
                .then(r => r.json())
                .then(data => {
                    chartComparativo.data.labels = data.labels;
                    chartComparativo.data.datasets[0].data = data.temperatura;
                    chartComparativo.data.datasets[1].data = data.humedad;
                    chartComparativo.update('none');
                })
                .catch(err => console.error('Error actualizando gr√°ficos:', err));
        }

        // ========== INICIALIZACI√ìN ==========
        window.addEventListener('load', () => {
            console.log('%cüß† Sistema MLP - Control Inteligente', 'color: #8250df; font-size: 20px; font-weight: bold;');
            console.log('%cDashboard con Horarios Configurables', 'color: #2ea043; font-size: 14px;');
            
            inicializarGraficos();
            // Inicializar visualizaci√≥n de neuronas
            generarNeuronasVisuales('layer1Neurons', 8);
            generarNeuronasVisuales('layer2Neurons', 6);
            generarNeuronasVisuales('layer3Neurons', 4);
            
            // Inicializar gr√°ficos de MLP Analytics
            inicializarGraficosMLPAnalytics();
            verificarSesionActiva();
            cargarHorarios();
            
            actualizarDashboard();
            actualizarGraficos();
            actualizarEstadoMLP();
            
            setInterval(actualizarDashboard, 2000);
            setInterval(actualizarGraficos, 5000);
            setInterval(actualizarEstadoMLP, 10000);
            setInterval(actualizarMLPAnalytics, 15000);  // Actualizar cada 15 segundos
            setInterval(actualizarTablaPrediciones, 5000);  // Actualizar cada 5 segundos
            
            // Actualizaci√≥n inicial
            actualizarMLPAnalytics();
            actualizarTablaPrediciones();
            
            console.log('‚úÖ Dashboard inicializado correctamente');
        });
    </script>
</body>
</html>
