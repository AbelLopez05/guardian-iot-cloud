<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema MLP - Control Inteligente</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            background: linear-gradient(135deg, #0d1117 0%, #1a1f2e 100%);
            color: #c9d1d9; 
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(22, 27, 34, 0.9);
            border-radius: 12px;
            border: 2px solid #8250df;
            box-shadow: 0 0 30px rgba(130, 80, 223, 0.3);
        }

        h1 { 
            color: #8250df; 
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(130, 80, 223, 0.5);
        }

        .status-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .status-badge {
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .badge-online { 
            background: #238636; 
            color: white;
            box-shadow: 0 0 15px rgba(35, 134, 54, 0.5);
        }

        .badge-offline { 
            background: #da3633; 
            color: white;
            animation: pulse 2s infinite;
        }

        .badge-mlp {
            background: #8250df;
            color: white;
            box-shadow: 0 0 15px rgba(130, 80, 223, 0.5);
        }

        .badge-auto {
            background: #238636;
            color: white;
            box-shadow: 0 0 15px rgba(35, 134, 54, 0.5);
        }

        .badge-manual {
            background: #d29922;
            color: white;
            box-shadow: 0 0 15px rgba(210, 153, 34, 0.7);
        }

        .badge-auth {
            background: #8250df;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .badge-auth:hover {
            transform: scale(1.05);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .section-title {
            color: #8b949e;
            text-transform: uppercase;
            font-size: 1.2em;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #8250df;
            letter-spacing: 2px;
        }

        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px;
        }

        .card { 
            background: linear-gradient(145deg, #161b22 0%, #0d1117 100%);
            border: 1px solid #30363d; 
            border-radius: 12px; 
            padding: 25px; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.6);
        }

        .lbl { 
            color: #8b949e; 
            font-size: 0.85em; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .val { 
            font-size: 3.5em; 
            font-weight: bold; 
            margin: 15px 0;
            background: linear-gradient(135deg, #8250df, #6e40c9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .unit {
            font-size: 0.5em;
            color: #8b949e;
        }

        .control-panel {
            background: linear-gradient(145deg, #161b22 0%, #0d1117 100%);
            border: 2px solid #388bfd;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 0 30px rgba(56, 139, 253, 0.3);
        }

        .mode-switch-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(22, 27, 34, 0.6);
            border-radius: 10px;
        }

        .mode-label {
            font-size: 1.2em;
            font-weight: bold;
            color: #c9d1d9;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 80px;
            height: 40px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #238636;
            transition: .4s;
            border-radius: 40px;
            box-shadow: 0 0 15px rgba(35, 134, 54, 0.5);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 32px;
            width: 32px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #d29922;
            box-shadow: 0 0 15px rgba(210, 153, 34, 0.7);
        }

        input:checked + .slider:before {
            transform: translateX(40px);
        }

        .manual-controls {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
            background: rgba(22, 27, 34, 0.4);
            border-radius: 10px;
        }

        .manual-controls.active {
            display: grid;
        }

        .relay-control {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background: linear-gradient(145deg, #21262d, #161b22);
            border-radius: 8px;
        }

        .relay-control-label {
            color: #8b949e;
            font-size: 0.9em;
            text-align: center;
        }

        .btn-relay {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        .btn-relay-off {
            background: linear-gradient(145deg, #21262d, #161b22);
            color: #8b949e;
            border: 2px solid #30363d;
        }

        .btn-relay-on {
            background: linear-gradient(145deg, #238636, #2ea043);
            color: white;
            box-shadow: 0 0 15px rgba(35, 134, 54, 0.5);
        }

        .mlp-panel {
            background: linear-gradient(145deg, #161b22 0%, #0d1117 100%);
            border: 2px solid #8250df;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 0 30px rgba(130, 80, 223, 0.3);
        }

        .btn-entrenar {
            padding: 14px 28px;
            background: linear-gradient(145deg, #8250df, #6e40c9);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(130, 80, 223, 0.5);
        }

        .btn-entrenar:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(130, 80, 223, 0.8);
        }

        .condicion-box {
            background: rgba(130, 80, 223, 0.1);
            border: 2px solid #8250df;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .condicion-box h4 {
            color: #8250df;
            margin-bottom: 8px;
        }

        .condicion-box ul {
            list-style: none;
            color: #c9d1d9;
            font-size: 0.9em;
        }

        .condicion-box li {
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }

        .condicion-box li:before {
            content: "‚ñ∏";
            position: absolute;
            left: 0;
            color: #8250df;
        }

        .relay-status { 
            padding: 15px; 
            border-radius: 8px; 
            font-weight: bold; 
            margin-top: 10px; 
            text-align: center;
            transition: all 0.3s;
        }

        .relay-off { 
            background: linear-gradient(145deg, #21262d, #161b22);
            color: #484f58; 
        }

        .relay-on { 
            background: linear-gradient(145deg, #238636, #1a6d2b);
            color: white;
            box-shadow: 0 0 20px rgba(35, 134, 54, 0.6);
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(35, 134, 54, 0.6); }
            50% { box-shadow: 0 0 30px rgba(35, 134, 54, 0.9); }
        }

        .relay-icon {
            font-size: 1.5em;
            display: block;
            margin-bottom: 8px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .chart-card {
            background: linear-gradient(145deg, #161b22 0%, #0d1117 100%);
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .btn-download {
            padding: 12px 24px;
            background: linear-gradient(145deg, #238636, #2ea043);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(35, 134, 54, 0.5);
        }

        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(35, 134, 54, 0.8);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-login {
            background: linear-gradient(145deg, #161b22 0%, #0d1117 100%);
            border: 2px solid #8250df;
            border-radius: 16px;
            padding: 40px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 0 50px rgba(130, 80, 223, 0.5);
        }

        .modal-header h2 {
            color: #8250df;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            color: #c9d1d9;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 14px;
            background: #0d1117;
            border: 2px solid #30363d;
            border-radius: 8px;
            color: #c9d1d9;
            font-size: 1em;
        }

        .form-group input:focus {
            outline: none;
            border-color: #8250df;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn-modal {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1em;
        }

        .btn-login {
            background: linear-gradient(145deg, #8250df, #6e40c9);
            color: white;
            box-shadow: 0 0 15px rgba(130, 80, 223, 0.5);
        }

        .btn-cancel {
            background: #21262d;
            color: #8b949e;
            border: 2px solid #30363d;
        }

        .error-message {
            background: #da3633;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #484f58;
            font-size: 0.85em;
        }

        @media (max-width: 768px) {
            h1 { font-size: 1.8em; }
            .val { font-size: 2.5em; }
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- MODAL LOGIN -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal-login">
            <div class="modal-header">
                <h2>üîê Acceso Administrativo</h2>
                <p style="color: #8b949e;">Ingresa tus credenciales para modo manual</p>
            </div>
            
            <div id="loginError" class="error-message">
                ‚ö†Ô∏è Credenciales incorrectas
            </div>
            
            <form id="loginForm" onsubmit="return false;">
                <div class="form-group">
                    <label>üë§ Usuario</label>
                    <input type="text" id="username" placeholder="admin" required>
                </div>
                
                <div class="form-group">
                    <label>üîë Contrase√±a</label>
                    <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn-modal btn-cancel" onclick="cancelarLogin()">Cancelar</button>
                    <button type="submit" class="btn-modal btn-login">Iniciar Sesi√≥n</button>
                </div>
            </form>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üß† SISTEMA MLP - CONTROL INTELIGENTE</h1>
            <p style="color: #8b949e; font-size: 1.1em;">Red Neuronal Perceptr√≥n Multicapa + Control Manual</p>
            
            <div class="status-bar">
                <div id="connection-badge" class="status-badge badge-offline">
                    <span>‚óè</span> <span>Conectando...</span>
                </div>
                <div id="mlp-badge" class="status-badge badge-mlp">
                    üß† MLP ACTIVO
                </div>
                <div id="mode-badge" class="status-badge badge-auto">
                    ü§ñ MODO AUTO
                </div>
                <div id="auth-badge" class="status-badge badge-auth" onclick="cerrarSesion()" style="display: none;">
                    üë§ ADMIN - Click para salir
                </div>
                <div class="status-badge" style="background: #1f6feb; color: white;">
                    ‚è±Ô∏è <span id="last-update">Sincronizando...</span>
                </div>
            </div>
        </div>

        <!-- PANEL DE CONTROL -->
        <div class="control-panel">
            <h2 class="section-title" style="margin-top: 0;">üéõÔ∏è Panel de Control del Sistema</h2>
            
            <div class="mode-switch-container">
                <span class="mode-label">ü§ñ AUTOM√ÅTICO (MLP)</span>
                <label class="switch">
                    <input type="checkbox" id="modeSwitch" onchange="cambiarModo()">
                    <span class="slider"></span>
                </label>
                <span class="mode-label">üéÆ MANUAL</span>
            </div>

            <div id="manualControls" class="manual-controls">
                <div class="relay-control">
                    <div class="relay-control-label">üîß MOTOR AC</div>
                    <button id="btnRelay1" class="btn-relay btn-relay-off" onclick="toggleRelay(1)">OFF</button>
                </div>
                <div class="relay-control">
                    <div class="relay-control-label">üí° FOCO 1</div>
                    <button id="btnRelay2" class="btn-relay btn-relay-off" onclick="toggleRelay(2)">OFF</button>
                </div>
                <div class="relay-control">
                    <div class="relay-control-label">üí° FOCO 2</div>
                    <button id="btnRelay3" class="btn-relay btn-relay-off" onclick="toggleRelay(3)">OFF</button>
                </div>
                <div class="relay-control">
                    <div class="relay-control-label">üîå RESERVA</div>
                    <button id="btnRelay4" class="btn-relay btn-relay-off" onclick="toggleRelay(4)">OFF</button>
                </div>
            </div>
        </div>

        <!-- PANEL MLP -->
        <div class="mlp-panel">
            <h2 class="section-title" style="margin-top: 0; border-color: #8250df;">ü§ñ Red Neuronal MLP</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div class="card" style="border-color: #8250df;">
                    <div class="lbl">üéØ ACCURACY</div>
                    <div class="val" style="font-size: 2.5em;">
                        <span id="mlp-accuracy">--</span><span class="unit">%</span>
                    </div>
                </div>
                <div class="card" style="border-color: #8250df;">
                    <div class="lbl">üìä MUESTRAS</div>
                    <div class="val" style="font-size: 2.5em;">
                        <span id="mlp-samples">--</span>
                    </div>
                </div>
                <div class="card" style="border-color: #8250df;">
                    <div class="lbl">üîÑ ITERACIONES</div>
                    <div class="val" style="font-size: 2.5em;">
                        <span id="mlp-iterations">--</span>
                    </div>
                </div>
                <div class="card" style="border-color: #8250df;">
                    <div class="lbl">‚öôÔ∏è PAR√ÅMETROS</div>
                    <div class="val" style="font-size: 2.5em;">
                        <span id="mlp-params">--</span>
                    </div>
                </div>
            </div>

            <div style="background: rgba(22, 27, 34, 0.6); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #8250df; margin-bottom: 15px;">üìê Arquitectura: [3] ‚Üí [16-8] ‚Üí [4]</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 0.9em;">
                    <div>
                        <strong style="color: #58a6ff;">Entradas (3):</strong><br>
                        ‚Ä¢ Temperatura (¬∞C)<br>
                        ‚Ä¢ Humedad (%)<br>
                        ‚Ä¢ Hora (24h)
                    </div>
                    <div>
                        <strong style="color: #2ea043;">Capas Ocultas:</strong><br>
                        ‚Ä¢ Capa 1: 16 neuronas (ReLU)<br>
                        ‚Ä¢ Capa 2: 8 neuronas (ReLU)
                    </div>
                    <div>
                        <strong style="color: #f0883e;">Salidas (4):</strong><br>
                        ‚Ä¢ Relay 1: Motor AC<br>
                        ‚Ä¢ Relay 2: Foco 1<br>
                        ‚Ä¢ Relay 3: Foco 2<br>
                        ‚Ä¢ Relay 4: Reserva
                    </div>
                </div>
            </div>

            <button class="btn-entrenar" onclick="entrenarMLP()">
                üß† Entrenar Red Neuronal MLP
            </button>
        </div>

        <!-- CONDICIONES -->
        <h2 class="section-title">üìã Condiciones de Activaci√≥n (Aprendidas por MLP)</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="condicion-box">
                <h4>üîß CONDICI√ìN 1 - Motor AC (Relay 1)</h4>
                <ul>
                    <li>Temperatura: 15 - 18 ¬∞C</li>
                    <li>Humedad: 80 - 90 %</li>
                    <li>Hora: 17:00 - 17:20</li>
                </ul>
            </div>
            <div class="condicion-box">
                <h4>üí° CONDICI√ìN 2 - Foco 1 (Relay 2)</h4>
                <ul>
                    <li>Temperatura: 18 - 20 ¬∞C</li>
                    <li>Humedad: 90 - 100 %</li>
                    <li>Hora: 17:30 - 18:00</li>
                </ul>
            </div>
            <div class="condicion-box">
                <h4>üí° CONDICI√ìN 3 - Foco 2 (Relay 3)</h4>
                <ul>
                    <li>Temperatura: 20 - 25 ¬∞C</li>
                    <li>Humedad: 80 - 90 %</li>
                    <li>Hora: 17:30 - 18:00</li>
                </ul>
            </div>
        </div>

        <!-- SENSORES -->
        <h2 class="section-title">üìä Lecturas de Sensores en Tiempo Real</h2>
        <div class="grid">
            <div class="card">
                <div class="lbl">üå°Ô∏è TEMPERATURA</div>
                <div class="val">
                    <span id="temp">--</span><span class="unit">¬∞C</span>
                </div>
            </div>
            
            <div class="card">
                <div class="lbl">üíß HUMEDAD RELATIVA</div>
                <div class="val">
                    <span id="hum">--</span><span class="unit">%</span>
                </div>
            </div>

            <div class="card">
                <div class="lbl">‚è∞ HORA ACTUAL</div>
                <div class="val" style="font-size: 2.5em;">
                    <span id="hora">--:--</span>
                </div>
            </div>
        </div>

        <!-- KPIs -->
        <h2 class="section-title">üìà Indicadores Clave (KPIs)</h2>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
            <div class="card">
                <div class="lbl">üî∫ TEMP M√ÅXIMA</div>
                <div class="val" style="font-size: 2.5em;">
                    <span id="kpi-temp-max">--</span><span class="unit">¬∞C</span>
                </div>
            </div>
            <div class="card">
                <div class="lbl">üîª TEMP M√çNIMA</div>
                <div class="val" style="font-size: 2.5em;">
                    <span id="kpi-temp-min">--</span><span class="unit">¬∞C</span>
                </div>
            </div>
            <div class="card">
                <div class="lbl">üìä TEMP PROMEDIO</div>
                <div class="val" style="font-size: 2.5em;">
                    <span id="kpi-temp-avg">--</span><span class="unit">¬∞C</span>
                </div>
            </div>
            <div class="card">
                <div class="lbl">üíß HUM PROMEDIO</div>
                <div class="val" style="font-size: 2.5em;">
                    <span id="kpi-hum-avg">--</span><span class="unit">%</span>
                </div>
            </div>
            <div class="card">
                <div class="lbl">üîß CICLOS MOTOR</div>
                <div class="val" style="font-size: 2.5em;">
                    <span id="kpi-ciclos">0</span>
                </div>
            </div>
            <div class="card">
                <div class="lbl">‚è±Ô∏è UPTIME</div>
                <div class="val" style="font-size: 1.8em;">
                    <span id="kpi-uptime">00:00:00</span>
                </div>
            </div>
        </div>

        <!-- GR√ÅFICOS -->
        <h2 class="section-title">üìâ Monitoreo en Tiempo Real</h2>
        
        <div class="chart-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #58a6ff; font-size: 1.3em;">üìä Comparativa Temp vs Humedad</h3>
                <button class="btn-download" onclick="descargarReportePDF()">
                    üìÑ Descargar PDF
                </button>
            </div>
            <div class="chart-container">
                <canvas id="chartComparativo"></canvas>
            </div>
        </div>

        <!-- RELAYS -->
        <h2 class="section-title">üîå Estado de Rel√©s</h2>
        <div class="grid">
            <div class="card">
                <div class="lbl">RELAY 1 - Motor AC 220V</div>
                <div id="relay1" class="relay-status relay-off">
                    <span class="relay-icon">üîß</span>
                    APAGADO
                </div>
            </div>
            <div class="card">
                <div class="lbl">RELAY 2 - Foco 1</div>
                <div id="relay2" class="relay-status relay-off">
                    <span class="relay-icon">üí°</span>
                    APAGADO
                </div>
            </div>
            <div class="card">
                <div class="lbl">RELAY 3 - Foco 2</div>
                <div id="relay3" class="relay-status relay-off">
                    <span class="relay-icon">üí°</span>
                    APAGADO
                </div>
            </div>
            <div class="card">
                <div class="lbl">RELAY 4 - Reserva</div>
                <div id="relay4" class="relay-status relay-off">
                    <span class="relay-icon">üîå</span>
                    APAGADO
                </div>
            </div>
        </div>

        <div class="footer">
            <p><strong>üß† Sistema MLP - Control Inteligente + Manual</strong></p>
            <p>ESP32 + DHT22 + Relay 4CH | Red Neuronal [3‚Üí16-8‚Üí4]</p>
            <p style="margin-top: 5px; font-size: 0.75em;">Examen Final - Automatizaci√≥n Industrial</p>
        </div>
    </div>

    <script>
        // ========== VARIABLES GLOBALES ==========
        let errorConsecutivos = 0;
        let modoActual = 'AUTO';
        let estadosManuales = { relay1: false, relay2: false, relay3: false, relay4: false };
        let adminAutenticado = false;
        let chartComparativo;

        // ========== INICIALIZACI√ìN DE GR√ÅFICOS ==========
        function inicializarGraficos() {
            const configComun = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        labels: { color: '#c9d1d9', font: { size: 12 } }
                    }
                },
                scales: {
                    x: { 
                        ticks: { color: '#8b949e', maxRotation: 45, minRotation: 0 }, 
                        grid: { color: '#30363d' } 
                    },
                    y: { 
                        ticks: { color: '#8b949e' }, 
                        grid: { color: '#30363d' } 
                    }
                },
                animation: {
                    duration: 750
                }
            };

            chartComparativo = new Chart(document.getElementById('chartComparativo'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Temperatura (¬∞C)',
                            data: [],
                            borderColor: '#58a6ff',
                            backgroundColor: 'rgba(88, 166, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y',
                            fill: true
                        },
                        {
                            label: 'Humedad (%)',
                            data: [],
                            borderColor: '#2ea043',
                            backgroundColor: 'rgba(46, 160, 67, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1',
                            fill: true
                        }
                    ]
                },
                options: {
                    ...configComun,
                    scales: {
                        x: { 
                            ticks: { color: '#8b949e', maxRotation: 45 }, 
                            grid: { color: '#30363d' } 
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: { color: '#58a6ff' },
                            grid: { color: '#30363d' },
                            title: { display: true, text: 'Temperatura (¬∞C)', color: '#58a6ff' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { color: '#2ea043' },
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'Humedad (%)', color: '#2ea043' }
                        }
                    }
                }
            });
        }

        function actualizarGraficos() {
            fetch('/api/grafico-datos')
                .then(r => r.json())
                .then(data => {
                    chartComparativo.data.labels = data.labels;
                    chartComparativo.data.datasets[0].data = data.temperatura;
                    chartComparativo.data.datasets[1].data = data.humedad;
                    chartComparativo.update('none');
                })
                .catch(err => console.error('Error actualizando gr√°ficos:', err));
        }

        // ========== DESCARGAS ==========
        function descargarReportePDF() {
            window.location.href = '/api/reporte/pdf';
        }

        // ========== AUTENTICACI√ìN ==========
        function mostrarModalLogin() {
            document.getElementById('loginModal').classList.add('active');
            document.getElementById('username').focus();
        }

        function ocultarModalLogin() {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').classList.remove('active');
        }

        function cancelarLogin() {
            ocultarModalLogin();
            document.getElementById('modeSwitch').checked = false;
        }

        async function intentarLogin(usuario, password) {
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ usuario, password })
                });

                const data = await response.json();

                if (data.ok) {
                    adminAutenticado = true;
                    ocultarModalLogin();
                    document.getElementById('auth-badge').style.display = 'flex';
                    console.log('‚úÖ Login exitoso');
                    return await cambiarModoConAuth('MANUAL');
                } else {
                    document.getElementById('loginError').classList.add('active');
                    setTimeout(() => {
                        document.getElementById('loginError').classList.remove('active');
                    }, 3000);
                    return false;
                }
            } catch (error) {
                console.error('Error en login:', error);
                alert('Error de conexi√≥n al servidor');
                return false;
            }
        }

        async function cerrarSesion() {
            if (!confirm('¬øCerrar sesi√≥n de administrador?')) return;

            try {
                await fetch('/api/auth/logout', { 
                    method: 'POST', 
                    credentials: 'include' 
                });
                adminAutenticado = false;
                document.getElementById('auth-badge').style.display = 'none';
                await cambiarModoConAuth('AUTO');
                document.getElementById('modeSwitch').checked = false;
                console.log('‚úÖ Sesi√≥n cerrada');
            } catch (error) {
                console.error('Error cerrando sesi√≥n:', error);
            }
        }

        async function verificarSesionActiva() {
            try {
                const response = await fetch('/api/auth/verificar', { credentials: 'include' });
                const data = await response.json();
                if (data.autenticado) {
                    adminAutenticado = true;
                    document.getElementById('auth-badge').style.display = 'flex';
                    console.log('‚úÖ Sesi√≥n administrativa activa');
                }
            } catch (error) {
                console.error('Error verificando sesi√≥n:', error);
            }
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await intentarLogin(
                document.getElementById('username').value,
                document.getElementById('password').value
            );
        });

        // ========== CONTROL DE MODO ==========
        async function cambiarModo() {
            const switchElement = document.getElementById('modeSwitch');
            const nuevoModo = switchElement.checked ? 'MANUAL' : 'AUTO';
            
            if (nuevoModo === 'MANUAL' && !adminAutenticado) {
                switchElement.checked = false;
                mostrarModalLogin();
                return;
            }
            
            await cambiarModoConAuth(nuevoModo);
        }

        async function cambiarModoConAuth(nuevoModo) {
            try {
                const response = await fetch('/api/modo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ modo: nuevoModo })
                });

                const data = await response.json();

                if (data.ok) {
                    modoActual = nuevoModo;
                    actualizarUIdelModo(nuevoModo);
                    console.log(`‚úì Modo cambiado a ${nuevoModo}`);
                    return true;
                } else if (data.requiere_auth) {
                    mostrarModalLogin();
                    return false;
                } else {
                    alert(`Error: ${data.error}`);
                    return false;
                }
            } catch (error) {
                console.error('Error cambiando modo:', error);
                alert('Error de conexi√≥n al cambiar modo');
                return false;
            }
        }

        function actualizarUIdelModo(modo) {
            const badge = document.getElementById('mode-badge');
            const controls = document.getElementById('manualControls');
            const switchElement = document.getElementById('modeSwitch');
            
            if (modo === 'MANUAL') {
                badge.className = 'status-badge badge-manual';
                badge.innerHTML = 'üéÆ MODO MANUAL';
                controls.classList.add('active');
                switchElement.checked = true;
            } else {
                badge.className = 'status-badge badge-auto';
                badge.innerHTML = 'ü§ñ MODO AUTO';
                controls.classList.remove('active');
                switchElement.checked = false;
            }
        }

        // ========== CONTROL MANUAL DE REL√âS ==========
        async function toggleRelay(num) {
            if (modoActual !== 'MANUAL') {
                alert('‚ö†Ô∏è Debes estar en modo MANUAL para controlar los rel√©s');
                return;
            }

            if (!adminAutenticado) {
                mostrarModalLogin();
                return;
            }

            const relay = `relay${num}`;
            const nuevoEstado = !estadosManuales[relay];
            
            try {
                const response = await fetch('/api/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ relay, estado: nuevoEstado })
                });

                const data = await response.json();

                if (data.ok) {
                    estadosManuales[relay] = nuevoEstado;
                    actualizarBotonRelay(num, nuevoEstado);
                    console.log(`‚úì ${relay} ‚Üí ${nuevoEstado ? 'ON' : 'OFF'}`);
                } else if (data.requiere_auth) {
                    mostrarModalLogin();
                } else {
                    alert(`Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error controlando relay:', error);
                alert('Error de conexi√≥n al controlar relay');
            }
        }

        function actualizarBotonRelay(num, estado) {
            const btn = document.getElementById(`btnRelay${num}`);
            btn.className = estado ? 'btn-relay btn-relay-on' : 'btn-relay btn-relay-off';
            btn.textContent = estado ? 'ON' : 'OFF';
        }

        // ========== ACTUALIZACI√ìN DE UI ==========
        function actualizarRelay(id, activo) {
            const el = document.getElementById(id);
            el.className = activo ? 'relay-status relay-on' : 'relay-status relay-off';
            el.innerHTML = `<span class="relay-icon">${activo ? '‚úÖ' : '‚ùå'}</span>${activo ? 'ENCENDIDO' : 'APAGADO'}`;
        }

        function actualizarDashboard() {
            fetch('/api/estado')
                .then(r => {
                    if (!r.ok) throw new Error('Error de red');
                    return r.json();
                })
                .then(data => {
                    errorConsecutivos = 0;

                    // Estado de conexi√≥n
                    const badge = document.getElementById('connection-badge');
                    badge.className = data.conectado ? 'status-badge badge-online' : 'status-badge badge-offline';
                    badge.innerHTML = data.conectado ? '<span>‚óè</span> <span>ESP32 Conectado</span>' : '<span>‚óè</span> <span>Desconectado</span>';

                    // Sincronizar modo
                    if (data.modo !== modoActual) {
                        modoActual = data.modo;
                        actualizarUIdelModo(data.modo);
                    }

                    // Actualizar estados manuales si estamos en modo MANUAL
                    if (data.modo === 'MANUAL') {
                        estadosManuales = {
                            relay1: data.relay1,
                            relay2: data.relay2,
                            relay3: data.relay3,
                            relay4: data.relay4
                        };
                        actualizarBotonRelay(1, data.relay1);
                        actualizarBotonRelay(2, data.relay2);
                        actualizarBotonRelay(3, data.relay3);
                        actualizarBotonRelay(4, data.relay4);
                    }

                    // Sensores
                    document.getElementById('temp').textContent = data.temperatura.toFixed(1);
                    document.getElementById('hum').textContent = data.humedad.toFixed(1);
                    
                    // Hora
                    const hora = Math.floor(data.hora_actual || 0);
                    const minutos = Math.round(((data.hora_actual || 0) % 1) * 60);
                    document.getElementById('hora').textContent = `${String(hora).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;

                    // √öltima actualizaci√≥n
                    document.getElementById('last-update').textContent = data.ultima_actualizacion || 'Esperando...';

                    // Relays
                    actualizarRelay('relay1', data.relay1);
                    actualizarRelay('relay2', data.relay2);
                    actualizarRelay('relay3', data.relay3);
                    actualizarRelay('relay4', data.relay4);
                })
                .catch(err => {
                    console.error('Error actualizando dashboard:', err);
                    errorConsecutivos++;
                    
                    if (errorConsecutivos > 5) {
                        const badge = document.getElementById('connection-badge');
                        badge.className = 'status-badge badge-offline';
                        badge.innerHTML = '<span>‚óè</span> <span>Error de Conexi√≥n</span>';
                    }
                });
        }

        function actualizarKPIs() {
            fetch('/api/kpis')
                .then(r => r.json())
                .then(kpis => {
                    document.getElementById('kpi-temp-max').textContent = kpis.temp_max.toFixed(1);
                    document.getElementById('kpi-temp-min').textContent = kpis.temp_min.toFixed(1);
                    document.getElementById('kpi-temp-avg').textContent = kpis.temp_promedio.toFixed(1);
                    document.getElementById('kpi-hum-avg').textContent = kpis.hum_promedio.toFixed(1);
                    document.getElementById('kpi-ciclos').textContent = kpis.ciclos_motor;
                    document.getElementById('kpi-uptime').textContent = kpis.uptime_formato;
                })
                .catch(err => console.error('Error actualizando KPIs:', err));
        }

        function actualizarEstadoMLP() {
            fetch('/api/mlp/estado')
                .then(r => r.json())
                .then(data => {
                    if (data.entrenado) {
                        document.getElementById('mlp-accuracy').textContent = data.metricas.accuracy.toFixed(1);
                        document.getElementById('mlp-samples').textContent = data.metricas.samples_trained;
                        document.getElementById('mlp-iterations').textContent = data.metricas.iterations;
                        document.getElementById('mlp-params').textContent = data.arquitectura.total_parametros;
                        
                        // Actualizar badge MLP
                        const mlpBadge = document.getElementById('mlp-badge');
                        mlpBadge.innerHTML = `üß† MLP: ${data.metricas.accuracy.toFixed(1)}%`;
                    } else {
                        document.getElementById('mlp-accuracy').textContent = '--';
                        document.getElementById('mlp-samples').textContent = '--';
                        document.getElementById('mlp-iterations').textContent = '--';
                        document.getElementById('mlp-params').textContent = '--';
                    }
                })
                .catch(err => console.error('Error actualizando estado MLP:', err));
        }

        // ========== ENTRENAMIENTO MLP ==========
        async function entrenarMLP() {
            if (!adminAutenticado) {
                mostrarModalLogin();
                return;
            }

            if (!confirm('¬øEntrenar la Red Neuronal MLP?\n\nEsto puede tardar unos segundos y se generar√°n nuevas decisiones basadas en las 3 condiciones del sistema.')) return;

            const btnEntrenar = document.querySelector('.btn-entrenar');
            btnEntrenar.disabled = true;
            btnEntrenar.textContent = '‚è≥ Entrenando...';

            try {
                const response = await fetch('/api/mlp/entrenar', {
                    method: 'POST',
                    credentials: 'include'
                });

                const resultado = await response.json();

                if (resultado.success) {
                    alert(`‚úÖ Red Neuronal MLP Entrenada Exitosamente!\n\n` +
                          `üìä M√©tricas:\n` +
                          `- Accuracy: ${resultado.metricas.accuracy}%\n` +
                          `- Muestras: ${resultado.metricas.samples_trained}\n` +
                          `- Iteraciones: ${resultado.metricas.iterations}\n` +
                          `- Tiempo: ${resultado.metricas.training_time}s\n\n` +
                          `El sistema est√° listo para tomar decisiones inteligentes.`);
                    actualizarEstadoMLP();
                } else if (resultado.requiere_auth) {
                    mostrarModalLogin();
                } else {
                    alert(`‚ùå Error en entrenamiento:\n${resultado.mensaje}`);
                }
            } catch (error) {
                console.error('Error entrenando MLP:', error);
                alert('Error de conexi√≥n al entrenar el modelo');
            } finally {
                btnEntrenar.disabled = false;
                btnEntrenar.textContent = 'üß† Entrenar Red Neuronal MLP';
            }
        }

        // ========== INICIALIZACI√ìN ==========
        window.addEventListener('load', () => {
            console.log('%cüß† Sistema MLP - Control Inteligente', 'color: #8250df; font-size: 20px; font-weight: bold;');
            console.log('%cDashboard iniciado correctamente', 'color: #2ea043; font-size: 14px;');
            
            // Inicializar componentes
            inicializarGraficos();
            verificarSesionActiva();
            
            // Primera actualizaci√≥n inmediata
            actualizarDashboard();
            actualizarKPIs();
            actualizarGraficos();
            actualizarEstadoMLP();
            
            // Intervalos de actualizaci√≥n
            setInterval(actualizarDashboard, 2000);     // Cada 2 segundos
            setInterval(actualizarKPIs, 5000);          // Cada 5 segundos
            setInterval(actualizarGraficos, 5000);      // Cada 5 segundos
            setInterval(actualizarEstadoMLP, 10000);    // Cada 10 segundos
            
            console.log('‚úÖ Todos los intervalos de actualizaci√≥n configurados');
        });

        // Manejo de errores globales
        window.addEventListener('error', (e) => {
            console.error('Error global capturado:', e.error);
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('Promesa rechazada:', e.reason);
        });
    </script>
</body>
</html>
